#{extends 'main.html' /}
#{set title:'grid2osm' /}
#{set 'moreScripts'}
	#{get 'moreScripts' /}
	<script type='text/javascript'>
		var row_bottom_collapsed = true;
		var row_top_collapsed = true;
		function showPoi(poi) {
			if (row_top_collapsed) {
				row_top_collapsed = false;
				$('#row_top').collapse('show');
				
				var poiId = poi.options.id;
				var action = #{jsAction @getPoi(':poiId') /};
				$('#poi').load(action({poiId: poiId}), function() {
				
					action = #{jsAction @getPoiPowerTag(':poiId', ':powerTag') /};
					var powerTag = encodeURIComponent($('#poi_power_tag').val());
					$('#poi_power_tag_details').load(action({poiId: poiId, powerTag: powerTag}), function() {
					
						if ($('#poi_power_tag').val() === 'Generator') {
							if ($('#source').val()) {
							
								action = #{jsAction @getPoiPowerTagGeneratorMethod(':poiId', ':source') /};
								var source = encodeURIComponent($('#source').val());
								$('#generator_method').load(action({poiId: $('#poi_id').val(), source: source}), function() {
								
									if ($('#method').val()) {
										action = #{jsAction @getPoiPowerTagGeneratorType(':poiId', ':sourceMethod') /};
										var source = encodeURIComponent($('#source').val());
										var method = encodeURIComponent($('#method').val());
										var sourceMethod;
										if (!source) {
											source = '';
										}
										if (!method) {
											method = '';
										}
										if (source === '' || method === ''){
											sourceMethod = source + method;
										} else {
											sourceMethod = source + '_' + method;
										}
										if (sourceMethod) {
											$('#generator_type').load(action({poiId: $('#poi_id').val(), sourceMethod: sourceMethod}));
										}
									}
								});
							}
						}
					});
				});
			}
		};
		function showPhoto(photo) {
			var tempPhotoArray = photoArray;
			photoArray = [];
			for (var i = 0; i < tempPhotoArray.length; i++) {
				var currentPhoto = tempPhotoArray[i];
				var spin = false;
				if (photo.options.id === currentPhoto.options.id) {
					spin = true;
				}
				addMarker(currentPhoto.options.id, currentPhoto._latlng.lat, currentPhoto._latlng.lng, 'photo', spin);
			}

			if (row_bottom_collapsed) {
				row_bottom_collapsed = false;
				$('#row_bottom').collapse('show');
			}
			
			var action = #{jsAction @getPhoto(':photoId') /};
			$('#photo').load(action({photoId: photo.options.id}));
		};
		$(document).on('change', '#poi_power_tag', function() {
			if ($('#poi_power_tag').val() === 'null') {
				$('#poi_power_tag_details').empty();
			} else {
				var action = #{jsAction @getPoiPowerTag(':poiId', ':powerTag') /};
				var powerTag = encodeURIComponent($('#poi_power_tag').val());
				$('#poi_power_tag_details').load(action({poiId: $('#poi_id').val(), powerTag: powerTag}));
			};
		});
		$(document).on('change', '#source', function() {
			if ($('#source').val() === 'null') {
				$('#generator_method').empty();
				$('#generator_type').empty();
			} else {
				var action = #{jsAction @getPoiPowerTagGeneratorMethod(':poiId', ':source') /};
				var source = encodeURIComponent($('#source').val());
				$('#generator_method').load(action({poiId: $('#poi_id').val(), source: source}), function() {
				
					if ($('#method').val() === 'null') {
						$('#generator_type').empty();
					} else {
						var action = #{jsAction @getPoiPowerTagGeneratorType(':poiId', ':sourceMethod') /};
						var source = encodeURIComponent($('#source').val());
						var method = encodeURIComponent($('#method').val());
						var sourceMethod;
						if (!source) {
							source = '';
						}
						if (!method) {
							method = '';
						}
						if (source === '' || method === ''){
							sourceMethod = source + method;
						} else {
							sourceMethod = source + '_' + method;
						}
						if (sourceMethod) {
							$('#generator_type').load(action({poiId: $('#poi_id').val(), sourceMethod: sourceMethod}));
						}
					}
				});
			}
		});
		$(document).on('change', '#method', function() {
			if ($('#method').val() === 'null') {
				$('#generator_type').empty();
			} else {
				var action = #{jsAction @getPoiPowerTagGeneratorType(':poiId', ':sourceMethod') /};
				var source = encodeURIComponent($('#source').val());
				var method = encodeURIComponent($('#method').val());
				var sourceMethod;
				if (!source) {
					source = '';
				}
				if (!method) {
					method = '';
				}
				if (source === '' || method === ''){
					sourceMethod = source + method;
				} else {
					sourceMethod = source + '_' + method;
				}
				if (sourceMethod) {
					$('#generator_type').load(action({poiId: $('#poi_id').val(), sourceMethod: sourceMethod}));
				}
			}
		});
		$(document).on('click', '#poi_cancel', function() {
			$('#row_bottom').collapse('hide');
			$('#row_top').collapse('hide');
			$('#photo').empty();
			$('#poi').empty();
			row_bottom_collapsed = true;
			row_top_collapsed = true;

			map.removeLayer(polygon);
			for (var i = 0; i < photoArray.length; i++) {
				map.removeLayer(photoArray[i]);
			}
			photoArray = [];
		});
		$(document).on('click', '#poi_submit', function() {
			var updatePoiRoute = #{jsRoute @updatePoi() /};
			$.post(updatePoiRoute.url(),
				$('#poi_form').serialize())
				.done(function() {
					$('#poi_submit').removeClass('btn-warning');
					$('#poi_submit').addClass('btn-success');
				})
				.fail(function() {
					$('#poi_submit').removeClass('btn-success');
					$('#poi_submit').addClass('btn-warning');
				});
			return false;
		});
		$(document).on('click', '#poi_zoom', function() {
			var marker = getMarker($('#poi_id').val(), 'poi');
			if (photoArray.length !== 0) {
				var markerArray = photoArray.concat(new Array(marker));
				var group = new L.featureGroup(markerArray);
				map.fitBounds(group.getBounds());
			} else {
				map.setView(marker._latlng, 12);
			}
		});
	</script>
#{/set}
#{bootstrap /}
#{web_socket /}
<div id='table' class='container-fluid'>
	<div id='row_top' class='collapse row'>
		<div id='poi' class='col-xs-12'>
		</div>
	</div>
	<div id='row_middle' class='row'>
		<div class='col-xs-12'>
			#{map /}
		</div>
	</div>
	<div id='row_bottom' class='collapse row'>
		<div id='photo' class='col-xs-12'>
		</div>
	</div>
</div>
<script type='text/javascript'>
	(function() {
	#{list items:pois, as:'poi'}
	addMarker(${poi.id}, ${poi.latitude}, ${poi.longitude}, 'poi', false);
	#{/list}
	})();
</script>
